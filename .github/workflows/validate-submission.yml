name: Dot Pages - site upload validation
on:
  pull_request_target:
    types: [opened, synchronize, reopened]

permissions:
  pull-requests: write
  issues: write
  contents: read

jobs:
  check-submission:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout PR Code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}
          fetch-depth: 0

      - name: Json/Structure Validation
        env:
          GH_TOKEN: ${{ github.token }}
          PR_AUTHOR: ${{ github.event.pull_request.user.login }}
        run: |
          git fetch origin main:main || true

          CHANGED_FOLDERS=$(git diff --name-only main...HEAD | grep '^pages/' | cut -d/ -f2 | sort -u | grep -v '^_template' || true)

          if [ -z "$CHANGED_FOLDERS" ]; then
            echo "No changes detected in pages/ folders. Skipping validation."
            exit 0
          fi

          for FOLDER_NAME in $CHANGED_FOLDERS; do
            echo "--- Analyzing folder: $FOLDER_NAME ---"
            
            if git ls-tree -d main pages/$FOLDER_NAME > /dev/null 2>&1 && [ ! -d "pages/$FOLDER_NAME" ]; then
              echo "üóëÔ∏è Deletion detected for folder: $FOLDER_NAME"
              
              FIRST_OWNER=$(gh api "repos/${{ github.repository }}/commits?path=pages/$FOLDER_NAME&sha=main" --jq '.[-1].author.login')
              
              if [ "$FIRST_OWNER" != "null" ] && [ "$FIRST_OWNER" != "$PR_AUTHOR" ]; then
                echo "::error::Access Denied! You cannot delete '$FOLDER_NAME' because it belongs to $FIRST_OWNER."
                exit 1
              fi
              
              echo "‚úÖ Deletion authorized for $PR_AUTHOR."
              continue # Salta la validazione JSON perch√© la cartella non c'√® pi√π
            fi

            if git ls-tree -d main pages/$FOLDER_NAME > /dev/null 2>&1; then
              FIRST_OWNER=$(gh api "repos/${{ github.repository }}/commits?path=pages/$FOLDER_NAME&sha=main" --jq '.[-1].author.login')

              if [ "$FIRST_OWNER" != "null" ] && [ "$FIRST_OWNER" != "$PR_AUTHOR" ]; then
                echo "::error::Access Denied! Folder '$FOLDER_NAME' belongs to $FIRST_OWNER."
                exit 1
              fi
            fi

            # 3. VALIDAZIONE JSON (Solo per nuovi inserimenti o modifiche)
            CONFIG_PATH="pages/$FOLDER_NAME/config.json"
            if [ ! -f "$CONFIG_PATH" ]; then
              echo "::error file=$CONFIG_PATH::config.json file is missing."
              exit 1
            fi

            ROUTE=$(jq -r '.route' "$CONFIG_PATH")
            NAME=$(jq -r '.name' "$CONFIG_PATH")
            AUTH_NAME=$(jq -r '.author.name' "$CONFIG_PATH")
            CARD_COLOR=$(jq -r '.cardColor // empty' "$CONFIG_PATH")
            AUTH_URL=$(jq -r '.author.url' "$CONFIG_PATH")
            AUTH_PFP=$(jq -r '.author.pfp // empty' "$CONFIG_PATH")
            
            # Uniqueness Name Check
            DUPLICATE_NAME=$(find pages/ -maxdepth 2 -name "config.json" ! -path "$CONFIG_PATH" -exec jq -r '.name' {} + | grep -Fx "$NAME" || true)
            if [ -n "$DUPLICATE_NAME" ]; then
              echo "::error file=$CONFIG_PATH::The name '$NAME' is already taken."
              exit 1
            fi

            # Validation Rules
            if [ "$ROUTE" != "/$FOLDER_NAME" ]; then
              echo "::error file=$CONFIG_PATH::Route '$ROUTE' must match folder '/$FOLDER_NAME'."
              exit 1
            fi

            if [ "$NAME" == "null" ] || [ -z "$NAME" ]; then
              echo "::error file=$CONFIG_PATH::'name' field is missing."
              exit 1
            fi

            if [ -n "$CARD_COLOR" ] && [ "$CARD_COLOR" != "null" ]; then
              if [[ ! "$CARD_COLOR" =~ ^#([A-Fa-f0-9]{6}|[A-Fa-f0-9]{3})$ ]]; then
                echo "::error file=$CONFIG_PATH::Invalid HEX color."
                exit 1
              fi
            fi

            if [ -n "$AUTH_PFP" ] && [ "$AUTH_PFP" != "null" ]; then
              if [[ ! "$AUTH_PFP" =~ ^https?:// ]]; then
                echo "::error file=$CONFIG_PATH::Invalid PFP URL."
                exit 1
              fi
            fi

            if [[ ! "$AUTH_URL" =~ ^https?:// ]]; then
              echo "::error file=$CONFIG_PATH::Invalid author URL."
              exit 1
            fi
            
            echo "‚úÖ Validation successful for $FOLDER_NAME."
          done
      
      - name: Post Comment on Success
        if: success()
        uses: actions/github-script@v6
        with:
          script: |
            const runUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;
            const readmeUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/blob/main/README.md`;
            
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `‚úÖ **Validation Successful!**

            Hi @${context.payload.pull_request.user.login}, your submission has passed all automatic checks. 
            
            Please wait for a **staff member** to review and approve your Pull Request. We will merge it as soon as possible!`
            })

      - name: Post Comment on Failure
        if: failure()
        uses: actions/github-script@v6
        with:
          script: |
            const runUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;
            const readmeUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/blob/main/README.md`;
            
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `‚ö†Ô∏è **Validation Failed!**

            Hi @${context.payload.pull_request.user.login}, your submission could not be processed:
            - **Ownership**: You cannot modify or delete a folder created by someone else.
            - **Missing/Invalid**: Check your \`config.json\` or folder structure.

            ---
            üìñ **[Formatting Guide](${readmeUrl})** | üîç **[Error Details](${runUrl})**`
            })