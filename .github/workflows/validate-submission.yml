name: Dot Pages - site upload validation
on: [pull_request]

permissions:
  pull-requests: write
  contents: read
  issues: write

jobs:
  check-submission:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Json/Structure Validation
        env:
          PR_AUTHOR: ${{ github.event.pull_request.user.login }}
        run: |
          git fetch origin main:main || true
          
          CHANGED_FOLDERS=$(git diff --name-only main...HEAD | grep '^pages/' | cut -d/ -f2 | sort -u | grep -v '^_template' || true)

          if [ -z "$CHANGED_FOLDERS" ]; then
            echo "no folders changed. skipping validation"
            exit 0
          fi

          for FOLDER_NAME in $CHANGED_FOLDERS; do
            dir="pages/$FOLDER_NAME"
            CONFIG_PATH="$dir/config.json"
            
            echo "--- Checking modified folder: $FOLDER_NAME ---"

            if git show main:pages/$FOLDER_NAME/config.json > /dev/null 2>&1; then
              EXISTING_OWNER=$(git show main:pages/$FOLDER_NAME/config.json | jq -r '.author.github // .author.name')
              
              if [ "$EXISTING_OWNER" != "$PR_AUTHOR" ]; then
                echo "::error::Access Denied! Only $EXISTING_OWNER can modify the folder $FOLDER_NAME. (You are $PR_AUTHOR)"
                exit 1
              fi
            fi

            if [ ! -f "$CONFIG_PATH" ]; then
              echo "::error file=$CONFIG_PATH::config.json is missing"
              exit 1
            fi
            
            ROUTE=$(jq -r '.route' "$CONFIG_PATH")
            if [ "$ROUTE" != "/$FOLDER_NAME" ]; then
              echo "::error file=$CONFIG_PATH::Route '$ROUTE' non corrisponde alla cartella '/$FOLDER_NAME'"
              exit 1
            fi

            echo "✅ Validation successful for $FOLDER_NAME."
          done

      - name: Post Comment on Failure
        if: failure()
        uses: actions/github-script@v6
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: "⚠️ **Validazione Fallita!**\n\nHai provato a modificare una cartella non tua o ci sono errori nel file `config.json`.\n\nControlla i dettagli nei log cliccando su 'Details'."
            })